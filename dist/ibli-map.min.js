/**
 * ibli-map
 * @version v0.0.1 - 2014-10-14
 * @link https://github.com/Gizra/IBLI-map
 * @author  <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("ibliApp",["leaflet-directive"]).constant("BACKEND_URL","http://127.0.0.1:9000").factory("ibliHttpInterceptor",["$q","BACKEND_URL",function(a,b){return{request:function(c){return c.serverPredefined&&(c._url=b,c.url=angular.isDefined(c.apiMock)&&c.apiMock?c.url:c._url+c.url),c||a.when(c)}}}]).factory("ibliData",["$http","$q",function(a,b){function c(){var a=new Date,b=a.getMonth()+1,c=b>=3&&9>=b?"LRLD":"SRSD";return c}function d(){return["#000000","#AA0000","#BB5500","#DDDD00","#00AA00"]}function e(){return{weight:2,fillOpacity:.2}}function f(){return{center:{lat:1.1864,lng:37.925,zoom:6},defaults:{minZoom:6,maxZoom:9},tiles:{url:"https://{s}.tiles.mapbox.com/v3/ibli.jlgjoi4l/{z}/{x}/{y}.png",options:{id:"v3/examples.map-20v6611k"}},maxbounds:{southWest:{lat:-9.282399,lng:31.662597},northEast:{lat:10.998303,lng:44.703369}}}}function g(c){var d=b.defer();return a({method:"GET",url:"sites/default/files/data/zCumNDVI_Percentile.csv",serverPredefined:!0}).success(function(a){var b=a,e=b.split("\n");for(var f in e)e[f]&&(e[f]=e[f].split(","));var g=e.shift(),h=[],i=[];for(var j in g)if(g[j].match(/\d{4}[L|S]/)){var k=g[j].match(/\d{4}/)[0],m=g[j].match(/S/)?"Short season":"Long season";h.unshift({value:g[j],label:k+", "+m}),i[g[j]]=[],e.forEach(function(a){var b=parseInt(a[0]),c=parseInt(a[j]);i[g[j]][b]=c})}c||(c=h[0]),l=i[c.value],d.resolve(h)}),d.promise}function h(){var c=b.defer();return a({method:"GET",url:"sites/default/files/data/KenyaEthiopia_IBLIunits_July2014.topojson",serverPredefined:!0}).success(function(a){var b={data:topojson.feature(a,a.objects.KenyaEthiopia_IBLIunits_July2014),style:j,resetStyleOnMouseout:!0};c.resolve(b)}),c.promise}function i(){var c=b.defer();return a({method:"GET",url:"sites/default/files/data/rates.json",serverPredefined:!0}).success(function(a){var b={data:a};c.resolve(b)}),c.promise}function j(a){return{fillColor:k(a.properties.IBLI_ID),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.6}}function k(a){var b=l[a],c=d();return c[b-1]}var l=[];return{getMapOptions:function(){return f()},getHoverStyle:function(){return e()},getDivIdToIndex:function(a){return g(a)},getGeoJson:function(){return h()},getSeason:function(){return c()},getPremiumRates:function(){return i()}}}]).controller("MainCtrl",["$scope","$attrs","$http","$compile","$timeout","ibliData","leafletData","$window",function(a,b,c,d,e,f,g,h){angular.extend(a,{markers:{province:{lat:1.1864,lng:37.925,message:"",focus:!1,draggable:!1}},defaults:{scrollWheelZoom:!1},latLng:{lat:1.1864,lng:37.925},message:"",images_path:h.Drupal.settings.ibli_general.iblimap_images_path,controls:{custom:[]},premiumRate:0,calculatedSum:{},calculator:!1,insurers:[],calculatorData:{},calculatorCurrency:"KSh",markerOpen:!1,calculationRates:{camels:{APA:28e3,TIA:35e3,OIC:1e4},cows:{APA:2e4,TIA:25e3,OIC:6e3},goats:{APA:2e3,TIA:2500,OIC:8e3}},hoverDelay:0,clickDelay:250,divisionName:""},f.getMapOptions()),f.getDivIdToIndex().then(function(b){a.periods=b,void 0==a.period&&(a.period=a.periods[0]),f.getGeoJson().then(function(b){a.geojson=b})}),f.getPremiumRates().then(function(b){a.rates=b});var i=L.control();if(i.setPosition("bottomleft"),i.onAdd=function(){return d(angular.element('<img ng-src="'+a.images_path+'/legend.png"/>'))(a)[0]},a.controls.custom.push(i),"true"==b.periodList&&(a.savePDF=function(){a.loader=1,g.getMap().then(function(b){leafletImage(b,function(d,e){var f=document.createElement("img"),g=b.getSize();f.width=g.x,f.height=g.y,f.src=e.toDataURL();var h={map:f.src,period:a.period.value,map_width:f.width,map_height:f.height};c({method:"POST",url:"pim/save-pdf",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:jQuery.param(h)}).success(function(b){a.loader=0,a.pdf_path=b})})})}),"false"==b.periodList){var j=new Date,k=j.getMonth(),l=j.getFullYear(),m=j.getFullYear()+1;switch(a.payouts_sales={},!0){case 3>k:a.payouts_sales.new_payout="October "+l,a.payouts_sales.cur_payout="March "+l,a.payouts_sales.sales_date="Jan/Feb "+l;break;case 3==k:a.payouts_sales.new_payout="October "+l,a.payouts_sales.cur_payout="March "+l,a.payouts_sales.sales_date="Aug/Sep "+l;break;case k>3&&10>k:a.payouts_sales.new_payout="March "+m,a.payouts_sales.cur_payout="October "+l,a.payouts_sales.sales_date="Aug/Sep "+l;break;case k>=10:a.payouts_sales.new_payout="October "+m,a.payouts_sales.cur_payout="March "+m,a.payouts_sales.sales_date="Jan/Feb "+m}var n=L.control();n.setPosition("bottomright"),n.onAdd=function(){return d(angular.element("<payouts></payouts>"))(a)[0]},a.controls.custom.push(n)}a.$on("leafletDirectiveMap.geojsonMouseover",function(b,c){var d=c.target;d.setStyle(f.getHoverStyle()),d.bringToFront();var e=d.feature.properties,g=d.getBounds();if(a.latLng=g.getCenter(),!a.markerOpen&&e.IBLI_UNIT!=a.divisionName){var h=a.markers.province;h.focus=!1,h.lat=a.latLng.lat,h.lng=a.latLng.lng,h.message="<strong>"+e.IBLI_UNIT+"</strong>",h.focus=!0,a.divisionName=e.IBLI_UNIT}}),a.$on("leafletDirectiveMap.geojsonClick",function(b,c){a.calculatorCurrency="KSh";var f=c.properties,h=a.period.value.match(/L/)?"Aug/Sep":"Jan/Feb",i=a.period.value.match(/\d{4}/)[0];a.rates.data[f.IBLI_ID]&&(a.premiumRate=(100*a.rates.data[f.IBLI_ID][h+i]).toFixed(2));var j,k="",l="";switch(f.DISTRICT){case"WAJIR":case"MANDERA":case"GARISSA":j='<a href="http://www.takafulafrica.com/">Takaful</a>',a.insurers=["TIA"];break;case"ISIOLO":j='<a href="http://www.takafulafrica.com/">Takaful</a> | <a href="http://www.apainsurance.org/">APA</a>',a.insurers=["TIA","APA"];break;case"MARSABIT":j='<a href="http://www.apainsurance.org/">APA</a>',a.insurers=["APA"];break;case"MOYALE":case"IJARA":case"TANA RIVER":case"SAMBURU":case"BARINGO":case"TURKANA":j="TBD";break;default:j="TBD"}"ETHIOPIA"==f.COUNTRY&&(j="OIC",a.insurers=["OIC"],a.calculatorCurrency="Br"),a.premiumRate&&"NaN"!=a.premiumRate&&(k="<div>Premium Rate: <strong>"+a.premiumRate+"%</strong></div>"),a.premiumRate&&"NaN"!=a.premiumRate&&"TBD"!=j&&(l=d(angular.element("<rate-calculator></rate-calculator>"))(a)[0]);var m='<div id="popuop-data"><div><strong>'+f.IBLI_UNIT+"</strong></div>"+k;m+=(new Date).getFullYear()>i?"</div>":'<dl><dt>Insurer:</dt><dd class="insurers">'+j+"</dd></dl></div>",a.message=document.createElement("div"),a.message.innerHTML=m,l&&a.message.appendChild(l),a.markerOpen=L.popup();var n=a.markers.province;n.focus=!1,g.getMap().then(function(b){e(function(){a.markerOpen.setLatLng([a.latLng.lat,a.latLng.lng]).setContent(a.message).addTo(b)},a.clickDelay)})}),a.$on("leafletDirectiveMap.popupclose",function(){a.markerOpen=!1}),"true"==b.periodList&&a.$watch("period",function(){f.getDivIdToIndex(a.period).then(function(){f.getGeoJson().then(function(b){a.geojson=b})})})}]).directive("payouts",function(){var a=Drupal.settings.ibli_general.iblimap_library_path;return{templateUrl:a+"/templates/payouts.html",restrict:"EA",scope:!0}}).directive("rateCalculator",function(){var a=Drupal.settings.ibli_general.iblimap_library_path;return{templateUrl:a+"/templates/rate-calculator.html",restrict:"EA",scope:!0,link:function(a){a.toggleData=function(){a.calculatorData={cows:null,camels:null,goats:null},a.calculatedSum={},angular.element("#popuop-data").toggle(),a.calculator=!a.calculator,setTimeout(function(){a.markerOpen.update()},80)},a.calculateRate=function(b){var c=a.calculatorData,d=c.cows?c.cows:0,e=c.camels?c.camels:0,f=c.goats?c.goats:0;angular.forEach(a.insurers,function(b){a.calculatedSum[b]=(d*a.calculationRates.cows[b]+e*a.calculationRates.camels[b]+f*a.calculationRates.goats[b])*(a.premiumRate/100)}),setTimeout(function(){a.markerOpen.update(),angular.element(b).trigger("focus")},80)}}}});