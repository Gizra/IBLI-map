/**
 * ibli-map
 * @version v0.0.1 - 2014-09-02
 * @link https://github.com/Gizra/IBLI-map
 * @author  <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("ibliApp",["leaflet-directive"]).constant("BACKEND_URL","http://127.0.0.1:9000").factory("ibliHttpInterceptor",["$q","BACKEND_URL",function(a,b){return{request:function(c){return c.serverPredefined&&(c._url=b,c.url=angular.isDefined(c.apiMock)&&c.apiMock?c.url:c._url+c.url),c||a.when(c)}}}]).factory("ibliData",["$http","$q","$log",function(a,b,c){function d(){var a=new Date,b=a.getMonth()+1,c=b>=3&&9>=b?"LRLD":"SRSD";return c}function e(){return["#000000","#AA0000","#BB5500","#DDDD00","#00AA00"]}function f(){return{weight:2,fillOpacity:.2}}function g(){return{center:{lat:1.1864,lng:37.925,zoom:6},defaults:{minZoom:6,maxZoom:9},tiles:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{id:"v3/examples.map-20v6611k"}},maxbounds:{southWest:{lat:-9.282399,lng:31.662597},northEast:{lat:10.268303,lng:44.703369}}}}function h(c){var d=b.defer();return a({method:"GET",url:"sites/default/files/data/zCumNDVI_Percentile.csv",serverPredefined:!0}).success(function(a){var b=a,e=b.split("\n");for(var f in e)e[f]&&(e[f]=e[f].split(","));var g=e.shift(),h=[],i=[];for(var j in g)if(g[j].match(/\d{4}[L|S]/)){var k=g[j].match(/\d{4}/)[0],m=g[j].match(/S/)?"Short season":"Long season";h.unshift({value:g[j],label:k+", "+m}),i[g[j]]=[],e.forEach(function(a){var b=parseInt(a[0]),c=parseInt(a[j]);i[g[j]][b]=c})}c||(c=h[0]),l=i[c.value],d.resolve(h)}),d.promise}function i(){var c=b.defer();return a({method:"GET",url:"sites/default/files/data/KenyaEthiopia_IBLIunits_July2014.geojson",serverPredefined:!0}).success(function(a){var b={data:a,style:j,resetStyleOnMouseout:!0};c.resolve(b)}),c.promise}function j(a){return{fillColor:k(a.properties.IBLI_ID),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.6}}function k(a){var b=l[a],d=e();return c.log(d),d[b-1]}var l=[];return{getMapOptions:function(){return g()},getHoverStyle:function(){return f()},getDivIdToIndex:function(a){return h(a)},getGeoJson:function(){return i()},getSeason:function(){return d()}}}]).controller("MainCtrl",["$scope","$http","$compile","ibliData","$timeout",function(a,b,c,d,e){a.controls={custom:[]},angular.extend(a,{markers:{kenya:{lat:1.1864,lng:37.925,message:"",focus:!1,draggable:!1}},defaults:{scrollWheelZoom:!1}},d.getMapOptions()),d.getDivIdToIndex().then(function(b){a.periods=b,void 0==a.period&&(a.period=a.periods[0]),d.getGeoJson().then(function(b){a.geojson=b})}),a.nextSalesWindow="LRLD"==d.getSeason()?"Aug/Sept":"Jan/Feb",a.nextPayout="LRLD"==d.getSeason()?"March":"October";var f=L.control();f.setPosition("topright"),f.onAdd=function(){return c(angular.element('<select ng-model="period" ng-options="period.label for period in periods track by period.value"></select>'))(a)[0]},a.controls.custom.push(f),a.$on("leafletDirectiveMap.geojsonMouseover",function(b,c){var f=c.target;f.setStyle(d.getHoverStyle()),f.bringToFront();var g="",h=c.latlng,i=f.feature.properties,j=a.markers.kenya;switch(j.focus=!1,i.DISTRICT){case"WAJIR":case"MANDERA":case"GARISSA":g='<a href="http://www.takafulafrica.com/">Takaful</a>';break;case"ISIOLO":g='<a href="http://www.takafulafrica.com/">Takaful</a> | <a href="http://www.apainsurance.org/">APA</a>';break;case"MARSABIT":g='<a href="http://www.apainsurance.org/">APA</a>';break;case"MOYALE":case"IJARA":case"TANA RIVER":case"SAMBURU":case"BARINGO":case"TURKANA":g="TBD"}j.lat=h.lat,j.lng=h.lng,j.message="<div><strong>"+i.DIVI_WOR+"</strong><dl><dt>Next Sales Window:</dt><dd>"+a.nextSalesWindow+"</dd><dt>Next Potential Payout:</dt><dd>"+a.nextPayout+'</dd><dt>Insurer:</dt><dd class="insurers">'+g+"</dd></dl></div>",e(function(){j.focus=!0},350)}),a.$watch("period",function(){d.getDivIdToIndex(a.period).then(function(){d.getGeoJson().then(function(b){a.geojson=b})})})}]);